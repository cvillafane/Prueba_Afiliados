<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Afiliados - SiReLyF</title>
    
    <!-- Estilos (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LIBRERÍAS DESDE CLOUDFLARE (Más rápido y fiable) -->
    
    <!-- 1. React y ReactDOM (v17.0.2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    
    <!-- 2. Prop-types (Requisito de Recharts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js" crossorigin="anonymous"></script>
    
    <!-- 3. Recharts (v2.1.12 - Estable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.1.12/Recharts.min.js" crossorigin="anonymous"></script>
    
    <!-- 4. Babel (Para ejecutar el código) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js" crossorigin="anonymous"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .animate-fade { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root">
        <div class="flex items-center justify-center h-screen flex-col gap-4 text-slate-500">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p>Cargando sistema de análisis...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Iconos SVG simples
        const Icons = {
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        };

        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

        // Componente Tarjeta KPI
        const KpiCard = ({ title, value, icon, color, subtext }) => (
            <div className="card border-l-4 transition-transform hover:scale-105" style={{ borderColor: color }}>
                <div className="flex justify-between items-center">
                    <div>
                        <p className="text-sm font-bold text-gray-500 uppercase">{title}</p>
                        <h3 className="text-3xl font-extrabold text-gray-800 mt-1">{value}</h3>
                        <p className="text-xs text-gray-400 mt-1">{subtext}</p>
                    </div>
                    <div className="p-3 rounded-full bg-opacity-10" style={{ backgroundColor: color, color: color }}>
                        {icon}
                    </div>
                </div>
            </div>
        );

        function Dashboard() {
            // Estado para controlar si Recharts cargó
            const [rechartsLoaded, setRechartsLoaded] = useState(false);
            const [data, setData] = useState(null);
            const [fileName, setFileName] = useState('');
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Efecto para verificar carga de librería
            useEffect(() => {
                if (window.Recharts) {
                    setRechartsLoaded(true);
                } else {
                    // Reintentar cada 500ms si la conexión es lenta
                    const interval = setInterval(() => {
                        if (window.Recharts) {
                            setRechartsLoaded(true);
                            clearInterval(interval);
                        }
                    }, 500);
                    return () => clearInterval(interval);
                }
            }, []);

            // Acceso seguro a componentes de gráficos
            const Charts = window.Recharts || {};
            const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, AreaChart, Area } = Charts;

            // --- Lógica de Lectura del CSV ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoading(true);
                setFileName(file.name);

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const text = evt.target.result;
                        const rows = text.split('\n');
                        
                        // Detectar separador (tu archivo usa ';')
                        const headerRow = rows[0];
                        const separator = headerRow.includes(';') ? ';' : ',';
                        
                        // Limpiar cabeceras (quitar comillas y espacios)
                        const headers = headerRow.split(separator).map(h => h.trim().replace(/^"|"$/g, ''));
                        
                        // Mapeo de índices basado en tu archivo real
                        const findIdx = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));

                        const idxLegajo = headers.indexOf('Nro. Afiliado'); // Exacto
                        const idxApellido = headers.indexOf('Apellido Afiliado'); // Exacto
                        const idxNombre = headers.indexOf('Nombre Afiliado'); // Exacto
                        const idxCategoria = findIdx('Categoría'); // Flexible por tildes
                        const idxSeccional = findIdx('Seccional');
                        const idxEmpresa = findIdx('Empresa');
                        const idxSexo = findIdx('Sexo');
                        const idxEdad = findIdx('Edad');

                        const parsedData = [];
                        
                        for (let i = 1; i < rows.length; i++) {
                            if (!rows[i].trim()) continue;
                            
                            // Dividir fila
                            const row = rows[i].split(separator).map(cell => cell ? cell.trim().replace(/^"|"$/g, '') : '');
                            
                            // Validar fila mínima
                            if (row.length < 5) continue;

                            parsedData.push({
                                id: i,
                                legajo: row[idxLegajo] || 'S/D',
                                nombreCompleto: `${row[idxApellido] || ''} ${row[idxNombre] || ''}`.trim(),
                                categoria: row[idxCategoria] || 'Sin Categoría',
                                seccional: row[idxSeccional] || 'Desconocida',
                                empresa: row[idxEmpresa] || 'Sin Empresa',
                                sexo: row[idxSexo] || 'S/D',
                                edad: parseInt(row[idxEdad]) || 0
                            });
                        }
                        setData(parsedData);
                    } catch (err) {
                        alert("Error al procesar el archivo: " + err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                // Importante: ISO-8859-1 para leer tildes y ñ correctamente
                reader.readAsText(file, 'ISO-8859-1');
            };

            // --- Cálculos y Métricas ---
            const metrics = useMemo(() => {
                if (!data) return null;

                // 1. Filtro Global: Excluir Desvinculados
                const afiliadosValidos = data.filter(d => !d.categoria.toLowerCase().includes('desvinculado'));
                
                // 2. Segmentación
                const activos = afiliadosValidos.filter(d => d.categoria.toLowerCase().includes('activo'));
                const pasivos = afiliadosValidos.filter(d => !d.categoria.toLowerCase().includes('activo'));

                // 3. Promedio Edad
                const sumaEdad = afiliadosValidos.reduce((acc, curr) => acc + curr.edad, 0);
                const edadProm = (sumaEdad / (afiliadosValidos.length || 1)).toFixed(1);

                // 4. Función Agrupadora
                const agrupar = (lista, key) => {
                    const map = lista.reduce((acc, item) => {
                        const val = item[key] || 'S/D';
                        acc[val] = (acc[val] || 0) + 1;
                        return acc;
                    }, {});
                    return Object.keys(map)
                        .map(k => ({ name: k, value: map[k] }))
                        .sort((a, b) => b.value - a.value);
                };

                return {
                    listaCompleta: afiliadosValidos,
                    totalActivos: activos.length,
                    totalPasivos: pasivos.length,
                    totalGeneral: afiliadosValidos.length,
                    edadPromedio: edadProm,
                    porSeccional: agrupar(afiliadosValidos, 'seccional').slice(0, 10), // Top 10
                    porEmpresa: agrupar(afiliadosValidos, 'empresa').slice(0, 5), // Top 5
                    porCategoria: agrupar(afiliadosValidos, 'categoria'),
                    porSexo: agrupar(afiliadosValidos, 'sexo'),
                    porEdad: [
                        { name: '-30', value: afiliadosValidos.filter(x => x.edad > 0 && x.edad < 30).length },
                        { name: '30-50', value: afiliadosValidos.filter(x => x.edad >= 30 && x.edad <= 50).length },
                        { name: '51-65', value: afiliadosValidos.filter(x => x.edad > 50 && x.edad <= 65).length },
                        { name: '+65', value: afiliadosValidos.filter(x => x.edad > 65).length },
                    ]
                };
            }, [data]);

            // Filtro para la tabla
            const tablaFiltrada = useMemo(() => {
                if (!metrics) return [];
                const term = searchTerm.toLowerCase();
                return metrics.listaCompleta.filter(item => 
                    item.nombreCompleto.toLowerCase().includes(term) ||
                    item.legajo.toLowerCase().includes(term) ||
                    item.seccional.toLowerCase().includes(term)
                ).slice(0, 100); // Límite de 100 filas para rendimiento
            }, [metrics, searchTerm]);

            if (!rechartsLoaded) {
                return (
                    <div className="flex items-center justify-center h-screen flex-col gap-4 text-slate-500">
                        <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <p>Cargando librerías gráficas...</p>
                        <p className="text-xs">Si esto demora, revisa tu conexión.</p>
                    </div>
                );
            }

            // UI de Carga de Archivo
            if (!data) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-600 font-sans">
                        <div className="bg-white p-10 rounded-2xl shadow-lg text-center max-w-md mx-4 border border-slate-100">
                            <div className="bg-blue-100 p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6 text-blue-600">
                                <Icons.Upload />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 mb-2">Dashboard SiReLyF</h1>
                            <p className="mb-6 text-sm text-slate-500">Sube el archivo <b>Afiliados.csv</b> para generar las estadísticas automáticas.</p>
                            
                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-md transform hover:-translate-y-1">
                                <span className="flex items-center justify-center gap-2">
                                    {loading ? 'Procesando...' : 'Seleccionar Archivo CSV'}
                                </span>
                                <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                            </label>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-12 animate-fade bg-slate-50">
                    {/* Header */}
                    <nav className="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
                        <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-lg"><Icons.Users /></div>
                                <h1 className="font-bold text-lg tracking-wide">Dashboard SiReLyF</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className="text-sm text-slate-400 hidden md:block">{fileName}</span>
                                <button onClick={() => setData(null)} className="text-xs bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 px-3 py-1 rounded text-red-200 transition">
                                    Cerrar Archivo
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="container mx-auto px-4 py-8 space-y-6">
                        
                        {/* KPIs */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <KpiCard title="Total Activos" value={metrics.totalActivos} icon={<Icons.Check />} color="#3b82f6" subtext="Afiliados Plenos" />
                            <KpiCard title="Otros / Pasivos" value={metrics.totalPasivos} icon={<Icons.Users />} color="#f59e0b" subtext="Jubilados, Pensionados, etc." />
                            <KpiCard title="Padrón Total" value={metrics.totalGeneral} icon={<Icons.Briefcase />} color="#10b981" subtext="Excluyendo Desvinculados" />
                            <KpiCard title="Edad Promedio" value={metrics.edadPromedio} icon={<Icons.Users />} color="#8b5cf6" subtext="Años" />
                        </div>

                        {/* Gráficos Fila 1 */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Seccionales */}
                            <div className="card lg:col-span-2 h-96 flex flex-col">
                                <h3 className="font-bold text-slate-700 mb-4 text-lg">Afiliados por Seccional (Top 10)</h3>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={metrics.porSeccional} layout="vertical" margin={{left: 40}}>
                                            <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={140} tick={{fontSize: 11, fill: '#64748b'}} />
                                            <Tooltip cursor={{fill: '#f1f5f9'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)'}} />
                                            <Bar dataKey="value" fill="#3b82f6" radius={[0, 4, 4, 0]} barSize={20} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Categorías */}
                            <div className="card h-96 flex flex-col">
                                <h3 className="font-bold text-slate-700 mb-4 text-lg">Distribución por Categoría</h3>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie data={metrics.porCategoria} innerRadius={60} outerRadius={80} paddingAngle={2} dataKey="value">
                                                {metrics.porCategoria.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                ))}
                                            </Pie>
                                            <Tooltip contentStyle={{borderRadius: '8px'}} />
                                            <Legend verticalAlign="bottom" iconType="circle" wrapperStyle={{fontSize: '11px'}} />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Gráficos Fila 2 */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Empresas */}
                            <div className="card h-80 flex flex-col">
                                <h3 className="font-bold text-slate-700 mb-4 text-lg">Top 5 Empresas Empleadoras</h3>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={metrics.porEmpresa}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={{fontSize: 10, fill: '#64748b'}} interval={0} angle={-15} textAnchor="end" height={60} />
                                            <YAxis tick={{fill: '#64748b'}} />
                                            <Tooltip contentStyle={{borderRadius: '8px'}} />
                                            <Bar dataKey="value" fill="#8b5cf6" radius={[4, 4, 0, 0]} barSize={30} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Edades */}
                            <div className="card h-80 flex flex-col">
                                <h3 className="font-bold text-slate-700 mb-4 text-lg">Rango Etario</h3>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={metrics.porEdad}>
                                            <defs>
                                                <linearGradient id="colorEdad" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#f97316" stopOpacity={0.8}/>
                                                    <stop offset="95%" stopColor="#f97316" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                            <XAxis dataKey="name" tick={{fill: '#64748b'}} />
                                            <YAxis tick={{fill: '#64748b'}} />
                                            <Tooltip contentStyle={{borderRadius: '8px'}} />
                                            <Area type="monotone" dataKey="value" stroke="#f97316" fill="url(#colorEdad)" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>

                        {/* Tabla Detallada */}
                        <div className="card overflow-hidden p-0 shadow-lg">
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-center flex-wrap gap-4">
                                <h3 className="font-bold text-slate-700 text-lg">Padrón Detallado</h3>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400"><Icons.Search /></span>
                                    <input 
                                        type="text" 
                                        placeholder="Buscar afiliado..." 
                                        className="pl-10 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 transition"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="overflow-x-auto max-h-[500px]">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-100 text-slate-600 sticky top-0 z-10 uppercase text-xs font-bold">
                                        <tr>
                                            <th className="px-6 py-3">Legajo</th>
                                            <th className="px-6 py-3">Nombre Completo</th>
                                            <th className="px-6 py-3">Categoría</th>
                                            <th className="px-6 py-3">Seccional</th>
                                            <th className="px-6 py-3">Empresa</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {tablaFiltrada.map(row => (
                                            <tr key={row.id} className="hover:bg-blue-50 transition-colors">
                                                <td className="px-6 py-3 font-mono text-slate-500 font-semibold">{row.legajo}</td>
                                                <td className="px-6 py-3 font-medium text-slate-800">{row.nombreCompleto}</td>
                                                <td className="px-6 py-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold border ${
                                                        row.categoria.toLowerCase().includes('activo') 
                                                        ? 'bg-green-100 text-green-700 border-green-200' 
                                                        : 'bg-orange-100 text-orange-700 border-orange-200'
                                                    }`}>
                                                        {row.categoria}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-3 text-slate-600">{row.seccional}</td>
                                                <td className="px-6 py-3 text-slate-500">{row.empresa}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {tablaFiltrada.length === 0 && (
                                    <div className="p-12 text-center text-slate-400 flex flex-col items-center">
                                        <Icons.Search />
                                        <span className="mt-2">No se encontraron resultados para tu búsqueda.</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>